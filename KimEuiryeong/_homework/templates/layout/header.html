{% load static %}
{% block head %}
    <link rel="stylesheet" href="{% static 'css/layout/header.css' %}">
{% endblock head %}

<div class="header">
    <div class="header__logo" onclick="location.href='/jembot/'">
        <img src="{% static 'images/robot-icon.png' %}" alt="Robot Icon" class="header__logo-image" />
        <div class="header__logo-name">JemBot</div>
    </div>
    
    <!-- 주식 페이지에서만 표시되는 검색창 -->
    <div class="header__search" id="headerSearch" style="display: none;">
        <div class="header-search-container">
            <input type="text" id="headerStockSearchInput" placeholder="회사명을 입력하세요 (예: 삼성전자, 네이버)" class="header-search-input">
            <button id="headerStockSearchBtn" class="header-search-btn">
                <i class="bi bi-search"></i>
            </button>
        </div>
        <div class="header-search-suggestions" id="headerSearchSuggestions" style="display: none;">
            <div class="header-suggestions-title">혹시 이거 찾으세요?</div>
            <div class="header-suggestions-list" id="headerSuggestionsList"></div>
        </div>
    </div>
    
    <div class="header__actions">
         
        {% if user.is_authenticated %}
            <div class="header__profile">
                <div class="header__profile-image">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" alt="프로필" class="profile-img">
                    {% else %}
                        <div class="profile-default">{{ user.name|first }}</div>
                    {% endif %}
                </div>
                <div class="header__profile-dropdown">
                    <div class="header__profile-name" onclick="toggleProfileMenu()">
                        {{ user.name }} 님
                        <i class="bi bi-chevron-down profile-arrow"></i>
                    </div>
                    <div class="profile-dropdown-menu" id="profileDropdown">
                        <a href="{% url 'accounts:mypage' %}" class="dropdown-item">
                            <i class="bi bi-person"></i>
                            마이페이지
                        </a>
                        <a href="{% url 'app:favorites' %}" class="dropdown-item">
                            <i class="bi bi-heart"></i>
                            즐겨찾기
                        </a>
                        <a href="#" onclick="handleLogout(event)" class="dropdown-item">
                            <i class="bi bi-box-arrow-right"></i>
                            로그아웃
                        </a>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="header__login" onclick="location.href='{% url 'account_login' %}'">Login</div>
        {% endif %}

        <div class="header__help">?</div>   
    </div>
</div>

<script>
function toggleProfileMenu() {
    const dropdown = document.getElementById('profileDropdown');
    const arrow = document.querySelector('.profile-arrow');
    
    dropdown.classList.toggle('show');
    arrow.classList.toggle('rotated');
}

function handleLogout(event) {
    event.preventDefault();
    
    if (confirm('정말 로그아웃하시겠습니까?')) {
        // 로그아웃 폼 생성 및 제출
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "account_logout" %}';
        
        // CSRF 토큰 추가
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') || 
                         document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.getAttribute('content') || csrfToken.value;
            form.appendChild(csrfInput);
        }
        
        // next 파라미터 추가 (로그아웃 후 이동할 페이지)
        const nextInput = document.createElement('input');
        nextInput.type = 'hidden';
        nextInput.name = 'next';
        nextInput.value = '/jembot/';
        form.appendChild(nextInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// 클릭 외부 영역에서 드롭다운 닫기
document.addEventListener('click', function(event) {
    const profileDropdown = document.querySelector('.header__profile-dropdown');
    const dropdown = document.getElementById('profileDropdown');
    const arrow = document.querySelector('.profile-arrow');
    
    if (profileDropdown && !profileDropdown.contains(event.target)) {
        dropdown.classList.remove('show');
        arrow.classList.remove('rotated');
    }
});
</script>